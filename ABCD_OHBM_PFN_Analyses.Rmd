---
title: "ABCD_OHBM_PFN_Analyses"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width=250)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lsr)
library(lme4)
library(lmerTest)
library(mediation)
library(ggcorrplot)
library(corrplot)
library(RColorBrewer)
library(glmnet)
library(mgcv)
library(gamm4)
```


# First load in the spatial extent of each PFN (they're in order, 1-17)
# Then merge with the same datasets as above (NIH toolbox, trauma, etc.)
```{r}
pfn_sizes <- read.csv("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/All_PFN_sizes.csv")
nihtb<-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/NihTB/abcd_tbss01.txt",header=TRUE)
nihtb.baseline<-nihtb[nihtb$eventname=="baseline_year_1_arm_1",]
merged.data1 <- merge(pfn_sizes,nihtb.baseline,by="subjectkey")
lmt<-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/Thomp/lmtp201.txt",header=TRUE)
lmt.baseline<-lmt[lmt$eventname=="baseline_year_1_arm_1",]
merged.data2 <- merge(merged.data1,lmt.baseline[, c("subjectkey", setdiff(colnames(lmt.baseline),colnames(merged.data1)))],by="subjectkey")
ravlt<-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/Thomp/abcd_ps01.txt",header=TRUE)
ravlt.baseline<-ravlt[ravlt$eventname=="baseline_year_1_arm_1",]
merged.data3 <- merge(merged.data2,ravlt.baseline[, c("subjectkey", setdiff(colnames(ravlt.baseline),colnames(merged.data2)))],by="subjectkey")
trauma<-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/Strife/abcd_ptsd01.txt",header=TRUE)
trauma.baseline<-trauma[trauma$eventname=="baseline_year_1_arm_1",]
combined.data <- merge(merged.data3,trauma.baseline[, c("subjectkey", setdiff(colnames(trauma.baseline),colnames(merged.data3)))],by="subjectkey")
```


# Organize behavioral data
```{r}
# Coerce data types
combined.data$nihtbx_flanker_uncorrected <- as.numeric(combined.data$nihtbx_flanker_uncorrected)
combined.data$nihtbx_picvocab_uncorrected <- as.numeric(combined.data$nihtbx_picvocab_uncorrected)
combined.data$nihtbx_list_uncorrected <- as.numeric(combined.data$nihtbx_list_uncorrected)
combined.data$nihtbx_pattern_uncorrected <- as.numeric(combined.data$nihtbx_pattern_uncorrected)
combined.data$nihtbx_cardsort_uncorrected <- as.numeric(combined.data$nihtbx_cardsort_uncorrected)
combined.data$nihtbx_picture_uncorrected <- as.numeric(combined.data$nihtbx_picture_uncorrected)
combined.data$nihtbx_reading_uncorrected <- as.numeric(combined.data$nihtbx_reading_uncorrected)
combined.data$lmt_scr_perc_correct <- as.numeric(combined.data$lmt_scr_perc_correct)
combined.data$pea_ravlt_sd_trial_i_tc <- as.numeric(combined.data$pea_ravlt_sd_trial_i_tc)
combined.data$pea_ravlt_sd_trial_ii_tc <- as.numeric(combined.data$pea_ravlt_sd_trial_ii_tc)
combined.data$pea_ravlt_sd_trial_iii_tc <- as.numeric(combined.data$pea_ravlt_sd_trial_iii_tc)
combined.data$pea_ravlt_sd_trial_iv_tc <- as.numeric(combined.data$pea_ravlt_sd_trial_iv_tc)
combined.data$pea_ravlt_sd_trial_v_tc <- as.numeric(combined.data$pea_ravlt_sd_trial_v_tc)
combined.data$interview_age <- as.numeric(combined.data$interview_age)

ind_pea_ravlt = c(which(names(combined.data)=="pea_ravlt_sd_trial_i_tc"),which(names(combined.data)=="pea_ravlt_sd_trial_ii_tc"),
	which(names(combined.data)=="pea_ravlt_sd_trial_iii_tc"),which(names(combined.data)=="pea_ravlt_sd_trial_iv_tc"),
	which(names(combined.data)=="pea_ravlt_sd_trial_v_tc")); names(combined.data)[ind_pea_ravlt]; summary(combined.data[,ind_pea_ravlt])
combined.data$pea_ravlt_ld = apply(combined.data[,ind_pea_ravlt],1,sum)

combined.data$pea_ravlt_ld <- as.numeric(combined.data$pea_ravlt_ld)

# Rename according to Thompson 2018 code
names(combined.data)[which(names(combined.data)=="nihtbx_picvocab_uncorrected")] = "PicVocab"
names(combined.data)[which(names(combined.data)=="nihtbx_flanker_uncorrected")] = "Flanker"
names(combined.data)[which(names(combined.data)=="nihtbx_list_uncorrected")] = "List"
names(combined.data)[which(names(combined.data)=="nihtbx_cardsort_uncorrected")] = "CardSort"
names(combined.data)[which(names(combined.data)=="nihtbx_pattern_uncorrected")] = "Pattern"
names(combined.data)[which(names(combined.data)=="nihtbx_picture_uncorrected")] = "Picture"
names(combined.data)[which(names(combined.data)=="nihtbx_reading_uncorrected")] = "Reading"
names(combined.data)[which(names(combined.data)=="pea_ravlt_ld")] = "RAVLT"
names(combined.data)[which(names(combined.data)=="lmt_scr_perc_correct")] = "LMT"
```


# Remove subjects based on the following criteria:
## 1) 8min of retained TRs (600 TRs)
## 2) ABCD Booleans for rest and task
```{r}
num_TRs <- read.csv("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/num_TRs_by_subj_redo.csv")
data<-merge(combined.data,num_TRs,by="subjectkey")
data.clean<-data[data$numTRs>=600,] # we go from 9,132 to 8,293 at this step

# Remove participants based on booleans from ABCD
abcd_imgincl01 <- read.csv("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/abcd_imgincl01.csv")
abcd_imgincl01 <- abcd_imgincl01[abcd_imgincl01$eventnam=="baseline_year_1_arm_1",]
abcd_imgincl01 <- abcd_imgincl01[!abcd_imgincl01$visit=="",] # start here with 11,663 (8,287 of the 9,132 set)
abcd_imgincl01 <- abcd_imgincl01[abcd_imgincl01$imgincl_t1w_include==1,] # down to 11,124 (8,045 of the 9,132 set)
abcd_imgincl01 <- abcd_imgincl01[abcd_imgincl01$imgincl_rsfmri_include==1,] # down to 9,388 (7,475 of the 9,132 set)
abcd_imgincl01 <- abcd_imgincl01[abcd_imgincl01$imgincl_mid_include==1,] # down to 7,847 (6,344 of the 9,132 set)
abcd_imgincl01 <- abcd_imgincl01[abcd_imgincl01$imgincl_nback_include==1,] # down to 6,348 (5,161 of the 9,132 set)
abcd_imgincl01 <- abcd_imgincl01[abcd_imgincl01$imgincl_sst_include==1,] # down to 5,606 (4,164 of the 9,132 set)

combined.data <- merge(data.clean,abcd_imgincl01[, c("subjectkey",'imgincl_t1w_include')],by="subjectkey") # n=4,614


```


# Calculate Thompson factor scores
```{r}
combined.data$thompson_PC1 <- (0.754*combined.data$PicVocab)+(0.213*combined.data$Flanker)+(0.471*combined.data$List)+(0.205*combined.data$CardSort)+(0.015*combined.data$Pattern)+(0.012*combined.data$Picture)+(0.82*combined.data$Reading)+(0.306*combined.data$RAVLT)+(0.5*combined.data$LMT)

combined.data$thompson_PC2 <- (0.065*combined.data$PicVocab)+(0.712*combined.data$Flanker)+(0.148*combined.data$List)+(0.71*combined.data$CardSort)+(0.813*combined.data$Pattern)+(0.135*combined.data$Picture)+(0.12*combined.data$Reading)+(0.125*combined.data$RAVLT)+(0.299*combined.data$LMT)

combined.data$thompson_PC3 <- (0.19*combined.data$PicVocab)+(0.067*combined.data$Flanker)+(0.493*combined.data$List)+(0.232*combined.data$CardSort)+(0.085*combined.data$Pattern)+(0.863*combined.data$Picture)+(0.122*combined.data$Reading)+(0.712*combined.data$RAVLT)+(0.068*combined.data$LMT)

# Remove outliers
mean_PC1 <- mean(combined.data$thompson_PC1,na.rm=TRUE)
mean_PC2 <- mean(combined.data$thompson_PC2,na.rm=TRUE)
mean_PC3 <- mean(combined.data$thompson_PC3,na.rm=TRUE)
sd3_PC1 <- sd(combined.data$thompson_PC1,na.rm=TRUE)*3
sd3_PC2 <- sd(combined.data$thompson_PC2,na.rm=TRUE)*3
sd3_PC3 <- sd(combined.data$thompson_PC3,na.rm=TRUE)*3
sum(combined.data$thompson_PC1 > mean_PC1+sd3_PC1,na.rm=TRUE) # 8 outliers
sum(combined.data$thompson_PC2 > mean_PC2+sd3_PC2,na.rm=TRUE) # 2 outliers
sum(combined.data$thompson_PC3 > mean_PC3+sd3_PC3,na.rm=TRUE) # 0 outliers
combined.data.noOutliers <- combined.data[combined.data$thompson_PC1>(mean_PC1-sd3_PC1) & combined.data$thompson_PC1<(mean_PC1+sd3_PC1) & combined.data$thompson_PC2>(mean_PC2-sd3_PC2) & combined.data$thompson_PC2<(mean_PC2+sd3_PC2) & combined.data$thompson_PC3>(mean_PC3-sd3_PC3) & combined.data$thompson_PC3<(mean_PC3+sd3_PC3),]

# n=4,579
```


# Calculate ACEs variables
```{r}

# combined.data.noOutliers[,224:240]<-as.numeric(unlist(combined.data.noOutliers[,224:240]))
# 
# # Calculation of subscore with items related to physical and sexual abuse
# combined.data.noOutliers$abuse <- rowSums(data.frame(as.numeric(combined.data.noOutliers$ksads_ptsd_raw_761_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_762_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_763_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_767_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_768_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_769_p)),na.rm=TRUE)
# 
# # Calculation of subscore with items related to trauma (car accidents, natural disasters, loss, etc.)
# combined.data.noOutliers$trauma <- rowSums(data.frame(as.numeric(combined.data.noOutliers$ksads_ptsd_raw_754_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_755_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_756_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_757_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_758_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_759_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_760_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_766_p),as.numeric(combined.data.noOutliers$ksads_ptsd_raw_770_p)),na.rm=TRUE)
# 
# # Remember to add in this variable about family structure so we can use it as a covariate
# family <-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/ses/acspsw03.txt",header=TRUE)
# family.baseline<-family[family$eventname=="baseline_year_1_arm_1",]
# abcd.data <- merge(combined.data.noOutliers,family.baseline[, c("subjectkey", setdiff(colnames(family.baseline),colnames(combined.data.noOutliers)))],by="subjectkey")
# 
# emo.neglect <-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/neglect/crpbi01.txt",header=TRUE)
# emo.neglect.baseline<-emo.neglect[emo.neglect$eventname=="baseline_year_1_arm_1",]
# phy.neglect <-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/neglect/pmq01.txt",header=TRUE)
# phy.neglect.baseline<-phy.neglect[phy.neglect$eventname=="baseline_year_1_arm_1",]
# neglect.data <- merge(emo.neglect.baseline,phy.neglect.baseline[, c("subjectkey", setdiff(colnames(phy.neglect.baseline),colnames(emo.neglect.baseline)))],by="subjectkey")
# 
# abcd.data<-merge(abcd.data,neglect.data[,c("subjectkey", setdiff(colnames(neglect.data),colnames(abcd.data)))],by="subjectkey")
# 
# # Calculate subscales of deprivation (emotional and physical neglect) - see this ref for motivation https://www.sciencedirect.com/science/article/pii/S2352289518300821
# abcd.data$acceptance <- rowSums(data.frame(as.numeric(abcd.data$crpbi_parent1_y),as.numeric(abcd.data$crpbi_parent2_y),as.numeric(abcd.data$crpbi_parent3_y),as.numeric(abcd.data$crpbi_parent4_y),as.numeric(abcd.data$crpbi_parent5_y)))
# 
# abcd.data$monitoring <- rowSums(data.frame(as.numeric(abcd.data$parent_monitor_q1_y),as.numeric(abcd.data$parent_monitor_q2_y),as.numeric(abcd.data$parent_monitor_q3_y),as.numeric(abcd.data$parent_monitor_q4_y),as.numeric(abcd.data$parent_monitor_q5_y)))
# 
# abcd.data$abuse.binary <- factor(abcd.data$abuse>=1,labels = c("No Abuse","Abuse"))
# abcd.data$abuse.binary.numeric <- as.numeric(abcd.data$abuse.binary)
# abcd.data$trauma.binary <- factor(abcd.data$trauma>=1,labels = c("No Trauma","Trauma"))
# abcd.data$trauma.binary.numeric <- as.numeric(abcd.data$trauma.binary)
# 
# median.monitoring = median(na.omit(abcd.data$monitoring))
# median.acceptance = median(na.omit(abcd.data$acceptance))
# abcd.data$monitoring.binary <- factor(abcd.data$monitoring<20,labels = c("Low Physical Neglect","High Physical Neglect"))
# abcd.data$monitoring.binary.numeric <- as.numeric(abcd.data$monitoring.binary)
# abcd.data$acceptance.binary <- factor(abcd.data$acceptance<7.5,labels = c("Low Emotional Neglect","High Emotional Neglect"))
# abcd.data$acceptance.binary.numeric <- as.numeric(abcd.data$acceptance.binary)
```


# More data prep (family ID, site ID, total FPN score, train/test)
```{r}
# calculate a total FPN score
combined.data$totalFPN <- rowSums(data.frame(as.numeric(combined.data$df4),as.numeric(combined.data$df16),as.numeric(combined.data$df18)))

# Remember to add in this variable about family structure so we can use it as a covariate
family <-read.table("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/ses/acspsw03.txt",header=TRUE)
family.baseline<-family[family$eventname=="baseline_year_1_arm_1",]
abcd.data.almost <- merge(combined.data,family.baseline[, c("subjectkey", setdiff(colnames(family.baseline),colnames(combined.data)))],by="subjectkey")

# also add in the variable for site ID to use as a covariate
site_info <- readRDS("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/DEAP-siteID.rds")
site.baseline<-site_info[site_info$event_name=="baseline_year_1_arm_1",]
colnames(site.baseline)[1]<-"subjectkey"
abcd.data.withFamAndSite <- merge(abcd.data.almost,site.baseline[,c("subjectkey", setdiff(colnames(site.baseline),colnames(abcd.data.almost)))],by="subjectkey")
 
# separate train and test sets
trainIDs <- read.csv("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/train.csv")
train.data <- merge(abcd.data.withFamAndSite,trainIDs,by="subjectkey") # n=2,290
test.data <- abcd.data.withFamAndSite[!is.element(abcd.data.withFamAndSite$subjectkey,trainIDs$subjectkey),] #n=2,323
```



# Run some models!
```{r}

# Network 17 is specifically associated with PC1 and not PC2 or PC3
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df18,data=train.data)) #***
summary(lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df18,data=train.data))
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df18,data=train.data))

# Network 15 is specifically associated with PC1 and PC3 but not PC2
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df16,data=train.data)) #**
summary(lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df16,data=train.data))
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df16,data=train.data)) #**

# Network 3 is not associated with any of the PCs
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df4,data=train.data)) 
summary(lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df4,data=train.data))
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df4,data=train.data))
```


```{r}
# # We already know that trauma and physical neglect are associated with impairment in PC1
# # Physical neglect is also associated with impairment in PC3
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data)) #**
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) #***
# summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) #***
# 
# 
# # Are any subtypes of ACEs associated with PFN topography?
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) # ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+acceptance.binary,data=train.data)) # ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+abuse.binary,data=train.data)) # ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data)) # ns
# 
# summary(lmer(df18~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) # ns
# summary(lmer(df18~interview_age+sex+(1|rel_family_id)+acceptance.binary,data=train.data)) # ns
# summary(lmer(df18~interview_age+sex+(1|rel_family_id)+abuse.binary,data=train.data)) # ns
# summary(lmer(df18~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data)) # ns
# 
# summary(lmer(df16~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) # ns (0.056)
# summary(lmer(df16~interview_age+sex+(1|rel_family_id)+acceptance.binary,data=train.data)) # ns
# summary(lmer(df16~interview_age+sex+(1|rel_family_id)+abuse.binary,data=train.data)) # ns
# summary(lmer(df16~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data)) # ns
# 
# summary(lmer(df4~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) # ns
# summary(lmer(df4~interview_age+sex+(1|rel_family_id)+acceptance.binary,data=train.data)) # ns
# summary(lmer(df4~interview_age+sex+(1|rel_family_id)+abuse.binary,data=train.data)) # ns
# summary(lmer(df4~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data)) # ns

```


# Mediation analyses -- these are significant!
```{r}
# Mediation: trauma --> Network 17 --> PC1 (path C does decrease) *
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data))
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary+df18,data=train.data))

bs_indir = c()
for (i in 1:1000){
  thisSample <- sample(c(1:length(train.data$subjectkey)),length(train.data$subjectkey),replace=TRUE)
  pathc<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data[thisSample,])
  pathcp<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary+df18,data=train.data[thisSample,])
  indir<-fixef(pathc)[4]-fixef(pathcp)[5]
  bs_indir <- c(bs_indir,indir)
}
t.test(bs_indir,conf.level=0.95)

# Mediation: trauma --> Network 15 --> PC1 (path C does not decrease)
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data))
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary+df16,data=train.data))


# Mediation: physical neglect --> Network 17 --> PC1 (path C does decrease) *
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data))
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary+df18,data=train.data))


bs_indir = c()
for (i in 1:1000){
  thisSample <- sample(c(1:length(train.data$subjectkey)),length(train.data$subjectkey),replace=TRUE)
  pathc<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data[thisSample,])
  pathcp<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary+df18,data=train.data[thisSample,])
  indir<-fixef(pathc)[4]-fixef(pathcp)[5]
  bs_indir <- c(bs_indir,indir)
}
t.test(bs_indir,conf.level=0.95)


# Mediation: physical neglect --> Network 15 --> PC1 (path C does not decrease)
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data))
summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary+df16,data=train.data))

# Mediation: physical neglect --> Network 17 --> PC3 (path C does decrease) *
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data))
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary+df18,data=train.data))

bs_indir = c()
for (i in 1:1000){
  thisSample <- sample(c(1:length(train.data$subjectkey)),length(train.data$subjectkey),replace=TRUE)
  pathc<-lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data[thisSample,])
  pathcp<-lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary+df18,data=train.data[thisSample,])
  indir<-fixef(pathc)[4]-fixef(pathcp)[5]
  bs_indir <- c(bs_indir,indir)
}
t.test(bs_indir,conf.level=0.95)

# Mediation: physical neglect --> Network 15 --> PC3 (path C does not decrease)
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data))
summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary+df16,data=train.data))


```



# No moderations were significant
```{r}
# # Moderation: trauma * Network 17 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary*df18,data=train.data))
# 
# # Moderation: trauma * Network 15 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary*df16,data=train.data))
# 
# # Moderation: physical neglect * Network 17 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary*df18,data=train.data))
# 
# # Moderation: physical neglect * Network 15 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary*df16,data=train.data))
# 
# # Moderation: physical neglect * Network 17 --> PC3
# summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary*df18,data=train.data))
# 
# # Moderation: physical neglect * Network 15 --> PC3 
# summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary*df16,data=train.data))
# 
# 
# # Moderation: sex * trauma * Network 17 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary*df18*sex,data=train.data))
# 
# # Moderation: sex * trauma * Network 15 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+trauma.binary*df16*sex,data=train.data))
# 
# # Moderation: sex * physical neglect * Network 17 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary*df18*sex,data=train.data))
# 
# # Moderation: sex * physical neglect * Network 15 --> PC1
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+monitoring.binary*df16*sex,data=train.data))
# 
# # Moderation: sex * physical neglect * Network 17 --> PC3
# summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary*df18*sex,data=train.data))
# 
# # Moderation: sex * physical neglect * Network 15 --> PC3 
# summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+monitoring.binary*df16*sex,data=train.data))
```


# Analyses of total FPN
```{r}
# summary(lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+totalFPN,data=train.data)) #**
# summary(lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+totalFPN,data=train.data)) #ns
# summary(lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+totalFPN,data=train.data)) #ns
# 
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+monitoring.binary,data=train.data)) #ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+acceptance.binary,data=train.data)) #ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+abuse.binary,data=train.data)) #ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+trauma.binary,data=train.data)) #ns
# 
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+monitoring.binary*sex,data=train.data)) #ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+acceptance.binary*sex,data=train.data)) #ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+abuse.binary*sex,data=train.data)) #ns
# summary(lmer(totalFPN~interview_age+sex+(1|rel_family_id)+trauma.binary*sex,data=train.data)) #ns

```


# Port data over to matlab (womp) so I can run the Canlab multilevel mediation toolbox 
```{r}
write.csv(train.data,file="trainData_forMatlab.csv")
write.csv(test.data,file="testData_forMatlab.csv")
```


# Create a correlation matrix of all the important variables
```{r}
# important.variables <- train.data[,c("interview_age","monitoring","acceptance","abuse","trauma","df2","df3","df4","df5","df6","df7","df8","df9","df10","df11","df12","df13","df14","df15","df16","df17","df18","thompson_PC1","thompson_PC2","thompson_PC3")]
# 
# colnames(important.variables)<-c("Age","Phys Neglect","Emo Neglect","Abuse","Trauma","PFN 1","PFN 2","PFN 3","PFN 4","PFN 5","PFN 6","PFN 7","PFN 8","PFN 9","PFN 10","PFN 11","PFN 12","PFN 13","PFN 14","PFN 15","PFN 16","PFN 17","General Cog (PC1)","Exec Fxn (PC2)","Learn/Mem (PC3)")
# 
# png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/ABCD_PFNs_ACES_Cog_CorrMatrix.png",
#     width = 8000, 
#     height = 4000,
#     res=300)
# corrplot(cor(important.variables,use="complete.obs"),method=c("number"), tl.col = "black", col=brewer.pal(n=8, name="Spectral"))
# dev.off() 
```

# Create a correlation matrix of just the cognitive and PFN variables
```{r}
important.variables <- train.data[,c("interview_age","df2","df3","df4","df5","df6","df7","df8","df9","df10","df11","df12","df13","df14","df15","df16","df17","df18","thompson_PC1","thompson_PC2","thompson_PC3")]

colnames(important.variables)<-c("Age","PFN 1","PFN 2","PFN 3","PFN 4","PFN 5","PFN 6","PFN 7","PFN 8","PFN 9","PFN 10","PFN 11","PFN 12","PFN 13","PFN 14","PFN 15","PFN 16","PFN 17","General Cog (PC1)","Exec Fxn (PC2)","Learn/Mem (PC3)")

png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/ABCD_PFNs_Cog_CorrMatrix.png",
    width = 8000, 
    height = 4000,
    res=300)
corrplot(cor(important.variables,use="complete.obs"),method=c("number"), tl.col = "black", col=brewer.pal(n=8, name="Spectral"))
dev.off() 
```



## Cui et al. 2020 replications
```{r}
correlation<-cor.test(combined.data[combined.data$df18>3000,]$thompson_PC1,combined.data[combined.data$df18>3000,]$df18)
png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/CuiRep_PC1_PFN17.png",
    width = 4000, 
    height = 4000,
    res=1000)
ggplot(data=combined.data[combined.data$df18>3000,],aes(thompson_PC1,df18))+geom_point(size=1,colour='gold')+geom_smooth(method=lm,colour='gray')+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + ylab('Network 17') + xlab('Thompson PC1: General Cognition') + ggtitle(paste("r=",as.character(round(correlation$estimate,3)),", p=",as.character(round(correlation$p.value,3))))
dev.off() 

correlation <- cor.test(combined.data$thompson_PC1,combined.data$df16)
png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/CuiRep_PC1_PFN15.png",
    width = 4000, 
    height = 4000,
    res=1000)
ggplot(data=combined.data,aes(thompson_PC1,df16))+geom_point(size=1,colour='gold')+geom_smooth(method=lm,colour='gray')+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +ylab('Network 15') + xlab('Thompson PC1: General Cognition') + ggtitle(paste("r=",as.character(round(correlation$estimate,3)),", p=",as.character(round(correlation$p.value,3))))
dev.off() 




correlation<-cor.test(combined.data$thompson_PC1,combined.data$df3)
png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/CuiRep_PC1_PFN2.png",
    width = 4000, 
    height = 4000,
    res=1000)
ggplot(data=combined.data,aes(thompson_PC1,df3))+geom_point(size=1,colour='steel blue')+geom_smooth(method=lm,colour='gray')+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +ylab('Network 2') + xlab('Thompson PC1: General Cognition') + ggtitle(paste("r=",as.character(round(correlation$estimate,3)),", p=",as.character(round(correlation$p.value,3))))
dev.off() 


correlation<-cor.test(combined.data$interview_age,combined.data$df5)
png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/CuiRep_Age_PFN4.png",
    width = 4000, 
    height = 4000,
    res=1000)
ggplot(data=combined.data,aes(interview_age,df5))+geom_point(size=1,colour='steel blue')+geom_smooth(method=lm,colour='gray')+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +ylab('Network 4') + xlab('Age')  + ggtitle(paste("r=",as.character(round(correlation$estimate,3)),", p=",as.character(round(correlation$p.value,3))))
dev.off() 

correlation<-cor.test(combined.data$interview_age,combined.data$df11)
png("/Users/ariellekeller/Documents/Kellernet_PrelimAnalysis/CuiRep_Age_PFN10.png",
    width = 4000, 
    height = 4000,
    res=1000)
ggplot(data=combined.data,aes(interview_age,df11))+geom_point(size=1,colour='purple')+geom_smooth(method=lm,colour='gray')+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +ylab('Network 10') + xlab('Age') + ggtitle(paste("r=",as.character(round(correlation$estimate,3)),", p=",as.character(round(correlation$p.value,3))))
dev.off() 


```



## Attempt at predictive modeling to see if we can predict the 3 independent domains of cognition from all the PFNs
# PC1
```{r}
base_model<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site),data=train.data)
pfn_model<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data)
anova(base_model,pfn_model,test="Chisq")

# Lasso to just use the PFNs that are relevant:
x=model.matrix(lm(thompson_PC1~df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data))
y=train.data[!is.na(train.data$thompson_PC1),]$thompson_PC1

#Use a second train/validation division to select the "lambda" for the lasso.
set.seed(42894)
train=sample(seq(2165),721,replace=FALSE)
lasso.tr=glmnet(x[train,],y[train])
pred=predict(lasso.tr,x[-train,])
rmse=sqrt(apply((y[-train]-pred)^2,2,mean))
plot(log(lasso.tr$lambda),rmse,type="b",xlab="Log(lambda")
lam.best=lasso.tr$lambda[order(rmse)[1]] # extracting the best lambda - this extracts that component -- order puts them in order
coef(lasso.tr,s=lam.best)

# Test whether the model significantly improves over not having PFNs included
base_model<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site),data=train.data)
pfn_model_lasso<-lmer(thompson_PC1~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df4+df5+df6+df7+df8+df10+df11+df13+df15+df16+df18,data=train.data)
anova(base_model,pfn_model_lasso,test="Chisq")

# Test whether the model can predict cognition in held out test data
pred.thompsonPC1<-predict(pfn_model_lasso,newdata=test.data[!is.na(test.data$thompson_PC1),c("interview_age","sex","rel_family_id","abcd_site","df4","df5","df6","df7","df8","df10","df11","df13","df15","df16","df18")],allow.new.levels=TRUE)
plot(test.data[!is.na(test.data$thompson_PC1),]$thompson_PC1,pred.thompsonPC1)
cor.test(test.data[!is.na(test.data$thompson_PC1),]$thompson_PC1,pred.thompsonPC1)
```

# PC2
```{r}
base_model<-lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site),data=train.data)
pfn_model<-lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data)
anova(base_model,pfn_model,test="Chisq")

# Lasso to just use the PFNs that are relevant:
x=model.matrix(lm(thompson_PC2~df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data))
y=train.data[!is.na(train.data$thompson_PC2),]$thompson_PC2

#Use a second train/validation division to select the "lambda" for the lasso.
set.seed(42894)
train=sample(seq(2165),721,replace=FALSE)
lasso.tr=glmnet(x[train,],y[train])
pred=predict(lasso.tr,x[-train,])
rmse=sqrt(apply((y[-train]-pred)^2,2,mean))
plot(log(lasso.tr$lambda),rmse,type="b",xlab="Log(lambda")
lam.best=lasso.tr$lambda[order(rmse)[1]] # extracting the best lambda - this extracts that component -- order puts them in order
coef(lasso.tr,s=lam.best)

# Test whether the model significantly improves over not having PFNs included
base_model<-lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site),data=train.data)
pfn_model_lasso<-lmer(thompson_PC2~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df2+df5+df7+df8+df10+df11+df12+df14+df17,data=train.data)
anova(base_model,pfn_model_lasso,test="Chisq")

# Test whether the model can predict cognition in held out test data
pred.thompsonPC2<-predict(pfn_model_lasso,newdata=test.data[!is.na(test.data$thompson_PC2),c("interview_age","sex","rel_family_id","abcd_site","df2","df5","df7","df8","df10","df11","df12","df14","df17")],allow.new.levels=TRUE)
plot(test.data[!is.na(test.data$thompson_PC2),]$thompson_PC2,pred.thompsonPC2)
cor.test(test.data[!is.na(test.data$thompson_PC2),]$thompson_PC2,pred.thompsonPC2)
```


# PC3
```{r}
base_model<-lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site),data=train.data)
pfn_model<-lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data)
anova(base_model,pfn_model,test="Chisq")

# Lasso to just use the PFNs that are relevant:
x=model.matrix(lm(thompson_PC3~df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data))
y=train.data[!is.na(train.data$thompson_PC3),]$thompson_PC3

#Use a second train/validation division to select the "lambda" for the lasso.
set.seed(42894)
train=sample(seq(2165),721,replace=FALSE)
lasso.tr=glmnet(x[train,],y[train])
pred=predict(lasso.tr,x[-train,])
rmse=sqrt(apply((y[-train]-pred)^2,2,mean))
plot(log(lasso.tr$lambda),rmse,type="b",xlab="Log(lambda")
lam.best=lasso.tr$lambda[order(rmse)[1]] # extracting the best lambda - this extracts that component -- order puts them in order
coef(lasso.tr,s=lam.best)

# Test whether the model significantly improves over not having PFNs included
base_model<-lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site),data=train.data)
pfn_model_lasso<-lmer(thompson_PC3~interview_age+sex+(1|rel_family_id)+(1|abcd_site)+df2+df5+df6+df7+df8+df10+df11+df15+df16+df18,data=train.data)
anova(base_model,pfn_model_lasso,test="Chisq")

# Test whether the model can predict cognition in held out test data
pred.thompsonPC3<-predict(pfn_model_lasso,newdata=test.data[!is.na(test.data$thompson_PC3),c("interview_age","sex","rel_family_id","abcd_site","df2","df5","df6","df7","df8","df10","df11","df15","df16","df18")],allow.new.levels=TRUE)
plot(test.data[!is.na(test.data$thompson_PC3),]$thompson_PC3,pred.thompsonPC3)
cor.test(test.data[!is.na(test.data$thompson_PC3),]$thompson_PC3,pred.thompsonPC3)
```


# A random attempt at using GAMs:
```{r}
train.data$rel_family_id <- as.factor(train.data$rel_family_id)
gam1<-gamm4(thompson_PC1~s(interview_age)+sex+s(rel_family_id,bs="re")+s(abcd_site,bs="re"),data=train.data,method="REML")
summary(gam1)
gam2<-gamm4(thompson_PC1~s(interview_age)+sex+s(rel_family_id,bs="re")+s(abcd_site,bs="re")+df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data,method="REML")
summary(gam2)
anova(gam1,gam2,test="Chisq")
AIC(gam1,gam2)

gam2<-gam(thompson_PC1~interview_age+sex+df2+df3+df4+df5+df6+df7+df8+df9+df10+df11+df12+df13+df14+df15+df16+df17+df18,data=train.data,method="REML")
summary(gam2)



```




